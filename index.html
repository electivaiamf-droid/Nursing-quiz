<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1,user-scalable=no">
<title>Nursing VR Quiz – FINAL & BULLETPROOF</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/loaders/GLTFLoader.js"></script>
<style>
  body{margin:0;overflow:hidden;background:#000;font-family:sans-serif;touch-action:none}
  #loading{position:fixed;inset:0;background:#0a1a2f;color:#fff;display:flex;flex-direction:column;justify-content:center;align-items:center;z-index:9999}
  .loader{border:16px solid #1e3a5f;border-top:16px solid #1caad9;border-radius:50%;width:90px;height:90px;animation:s 1s linear infinite}
  @keyframes s{to{transform:rotate(360deg)}}
  #ui{position:fixed;top:10px;left:50%;transform:translateX(-50%);background:rgba(0,0,0,.85);color:#fff;padding:20px 40px;border-radius:20px;z-index:100;display:none;width:90%;text-align:center}
  #q{font-size:36px;font-weight:bold;line-height:1.2}
  #s{font-size:30px;margin-top:10px}
  #vr{position:fixed;bottom:30px;left:50%;transform:translateX(-50%);padding:20px 60px;font-size:30px;background:#00bcd4;color:#fff;border:none;border-radius:50px;z-index:100;display:none;cursor:pointer}
  #fb{position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);font-size:70px;padding:40px 80px;border-radius:30px;display:none;z-index:200}
  .correct{background:#006400;color:#fff}
  .incorrect{background:#8B0000;color:#fff}
</style>
</head>
<body>
<div id="loading"><h1>Loading...</h1><div class="loader"></div></div>
<div id="ui"><div id="q"></div><div id="s">Score: 0/10</div></div>
<div id="fb"></div>
<button id="vr">Enter VR</button>

<script>
const BG="https://files.catbox.moe/reiuka.glb";
const vocab=[
  {name:"Adhesive Bandage",link:"https://files.catbox.moe/edy3gw.glb"},
  {name:"Hand Sanitizer",link:"https://files.catbox.moe/o997s6.glb"},
  {name:"Antiseptic Solution",link:"https://files.catbox.moe/1t002n.glb"},
  {name:"Cotton Balls",link:"https://files.catbox.moe/eay3dl.glb"},
  {name:"Gauze",link:"https://files.catbox.moe/vm9c7n.glb"},
  {name:"Medical Gloves",link:"https://files.catbox.moe/2tifp9.glb"},
  {name:"Saline Solution",link:"https://files.catbox.moe/dgg8tw.glb"},
  {name:"Scissors",link:"https://files.catbox.moe/bc4xkb.glb"},
  {name:"Tweezers",link:"https://files.catbox.moe/pf2i81.glb"},
  {name:"Thermometer",link:"https://files.catbox.moe/0glqs3.glb"}
];

let scene=new THREE.Scene(),camera=new THREE.PerspectiveCamera(70,innerWidth/innerHeight,0.01,1000),
    renderer=new THREE.WebGLRenderer({antialias:true,powerPreference:"high-performance"}),items=[],q=0,score=0,busy=false,gazed=null,gazeTime=0,isVR=false;

renderer.setPixelRatio(Math.min(devicePixelRatio,2));renderer.setSize(innerWidth,innerHeight);renderer.xr.enabled=true;document.body.appendChild(renderer.domElement);
camera.position.y=1.6;scene.add(new THREE.AmbientLight(0xffffff,1.2));scene.add(new THREE.DirectionalLight(0xffffff,1).position.set(5,10,7));

const loader=new THREE.GLTFLoader();
loader.load(BG,g=>scene.add(g.scene),null,()=>{const f=new THREE.Mesh(new THREE.CircleGeometry(20,64),new THREE.MeshStandardMaterial({color:0xaaa}));f.rotation.x=-Math.PI/2;scene.add(f);});

setTimeout(()=>{document.getElementById('loading').remove();document.getElementById('ui').style.display='block';document.getElementById('vr').style.display='block';loadItems();nextQuestion();renderer.setAnimationLoop(animate);},1200);

function loadItems(){
  const r=4.5;
  vocab.forEach((it,i)=>{
    const a=i*Math.PI*2/vocab.length,x=Math.cos(a)*r,z=Math.sin(a)*r,y=0.8+Math.random()*0.6;
    loader.load(it.link,gltf=>{
      const obj=gltf.scene;obj.position.set(x,y,z);
      obj.traverse(c=>{c.userData.name=it.name;c.userData.uses=it.uses;});
      const box=new THREE.Box3().setFromObject(obj);
      const size=box.getSize(new THREE.Vector3()).length();
      obj.scale.setScalar(1.4/size);
      
      // ←←← THIS FIXES "rotating toward walls" forever
      obj.up.set(0,1,0);
      obj.rotation.y=Math.random()*Math.PI;
      
      scene.add(obj);items.push(obj);
    });
  });
}

function nextQuestion(){
  const shuffled=[...vocab].sort(()=>Math.random()-.5);
  document.getElementById('q').textContent=`Find the ${shuffled[q].name}`;
  document.getElementById('s').textContent=`Score: ${score}/10`;
}

function answer(obj){
  if(busy)return;busy=true;
  const correct=obj.userData.name===document.getElementById('q').textContent.split("the ")[1];
  if(correct)score++;
  const fb=document.getElementById('fb');
  fb.textContent=correct?"Correct!":"Wrong!";
  fb.className=correct?"correct":"incorrect";
  fb.style.display="block";
  setTimeout(()=>{fb.style.display="none";q++;if(q<10)nextQuestion();else{fb.textContent=`Finished! ${score}/10`;fb.className="correct";}busy=false;},2500);
}

let lon=0,lat=0;
document.addEventListener('mousemove',e=>{lon=(e.clientX/innerWidth)*360-180;lat=-((e.clientY/innerHeight)*180-90);lat=Math.max(-85,Math.min(85,lat));});
function animate(){
  if(!isVR){lon*=0.92;lat*=0.92;const phi=THREE.MathUtils.degToRad(90-lat);const theta=THREE.MathUtils.degToRad(lon);camera.lookAt(camera.position.x+Math.sin(phi)*Math.cos(theta)*10,camera.position.y+Math.cos(phi)*10,camera.position.z+Math.sin(phi)*Math.sin(theta)*10);}
  items.forEach(o=>o.rotation.y+=0.01);
  if(!busy&&items.length>0){
    const r=new THREE.Raycaster();r.setFromCamera(new THREE.Vector2(0,0),camera);
    const h=r.intersectObjects(items,true);
    if(h.length){let o=h[0].object;while(o&&!o.userData.name)o=o.parent;
      if(o?.userData.name){
        if(gazed!==o){gazed=o;gazeTime=performance.now();}
        else if(performance.now()-gazeTime>800){answer(o);gazed=null;}
      }
    }
  }
  renderer.render(scene,camera);
}
renderer.domElement.addEventListener('click',()=>{if(busy||items.length<10)return;const r=new THREE.Raycaster();r.setFromCamera(new THREE.Vector2(0,0),camera);const h=r.intersectObjects(items,true);if(h.length){let o=h[0].object;while(o&&!o.userData.name)o=o.parent;if(o)answer(o);}});
document.getElementById('vr').onclick=()=>{navigator.xr?.requestSession('immersive-vr').then(s=>renderer.xr.setSession(s)).catch(()=>alert('VR not available'));};
window.onresize=()=>{camera.aspect=innerWidth/innerHeight;camera.updateProjectionMatrix();renderer.setSize(innerWidth,innerHeight);};
</script>
</body>
</html>
