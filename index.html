<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
<title>Nursing VR Quiz – Final Perfect Version</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/loaders/GLTFLoader.js"></script>
<style>
  body{margin:0;overflow:hidden;background:#000;font-family:sans-serif}
  #loading{position:fixed;inset:0;background:#0a1a2f;color:#fff;display:flex;flex-direction:column;justify-content:center;align-items:center;z-index:9999}
  .loader{border:16px solid #1e3a5f;border-top:16px solid #1caad9;border-radius:50%;width:90px;height:90px;animation:s 1s linear infinite;margin:20px}
  @keyframes s{to{transform:rotate(360deg)}}
  #ui{position:fixed;top:10px;left:50%;transform:translateX(-50%);background:rgba(0,0,0,0.85);color:#fff;padding:20px 40px;border-radius:20px;z-index:100;display:none;width:90%;text-align:center}
  #q{font-size:36px;font-weight:bold;line-height:1.2}
  #s{font-size:30px;margin-top:10px}
  #vr{position:fixed;bottom:30px;left:50%;transform:translateX(-50%);padding:20px 60px;font-size:30px;background:#00bcd4;color:#fff;border:none;border-radius:50px;z-index:100;display:none;cursor:pointer}
  #fb{position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);font-size:70px;padding:40px 80px;border-radius:30px;display:none;z-index:200}
  .correct{background:#006400;color:#fff}
  .incorrect{background:#8B0000;color:#fff}
  .reticle{position:fixed;top:50%;left:50%;width:60px;height:60px;border:6px solid #fff;border-radius:50%;transform:translate(-50%,-50%);pointer-events:none;z-index:99}
  .prog{position:fixed;top:50%;left:50%;width:90px;height:90px;border:10px solid transparent;border-top:10px solid cyan;border-radius:50%;transform:translate(-50%,-50%);display:none;animation:s 2s linear;z-index:99}
</style>
</head>
<body>
<div id="loading"><h1>Loading Hospital...</h1><div class="loader"></div></div>
<div id="ui"><div id="q"></div><div id="s">Score: 0/10</div></div>
<div class="reticle"></div>
<div class="prog" id="prog"></div>
<div id="fb"></div>
<button id="vr">Enter VR</button>

<script>
const BACKGROUND_FILE = "https://files.catbox.moe/reiuka.glb";

const vocab = [
  {name:"Adhesive Bandage",    link:"https://files.catbox.moe/edy3gw.glb", color:0xF5DEB3, uses:"A small bandage to cover minor cuts or wounds"},
  {name:"Hand Sanitizer",      link:"https://files.catbox.moe/o997s6.glb", color:0x87CEEB, uses:"A liquid used to disinfect hands"},
  {name:"Antiseptic Solution", link:"https://files.catbox.moe/1t002n.glb", color:0xDDA0DD, uses:"A liquid applied to wounds to prevent infection"},
  {name:"Cotton Balls",        link:"https://files.catbox.moe/eay3dl.glb", color:0xFFFFFF, uses:"Soft, absorbent material used for cleaning wounds"},
  {name:"Gauze",               link:"https://files.catbox.moe/vm9c7n.glb", color:0xFAFAFA, uses:"A type of thin, woven fabric used for dressing wounds"},
  {name:"Medical Gloves",      link:"https://files.catbox.moe/2tifp9.glb", color:0x98D8C8, uses:"Disposable gloves worn during medical procedures"},
  {name:"Saline Solution",     link:"https://files.catbox.moe/dgg8tw.glb", color:0xADD8E6, uses:"A mixture of salt and water, used for cleaning wounds"},
  {name:"Scissors",            link:"https://files.catbox.moe/bc4xkb.glb", color:0xC0C0C0, uses:"A tool for cutting"},
  {name:"Tweezers",            link:"https://files.catbox.moe/pf2i81.glb", color:0xB0B0B0, uses:"A tool for picking up small objects"},
  {name:"Thermometer",         link:"https://files.catbox.moe/0glqs3.glb", color:0xFF6B6B, uses:"A device used to measure body temperature"}
];

let scene = new THREE.Scene();
scene.background = new THREE.Color(0x0a1a2f);
let camera = new THREE.PerspectiveCamera(75, innerWidth/innerHeight, 0.1, 1000);
camera.position.y = 1.6;
let renderer = new THREE.WebGLRenderer({antialias:true, powerPreference:"high-performance"});
renderer.setPixelRatio(window.devicePixelRatio);
renderer.setSize(innerWidth, innerHeight);
renderer.xr.enabled = true;
document.body.appendChild(renderer.domElement);

scene.add(new THREE.AmbientLight(0xffffff, 0.9));
scene.add(new THREE.DirectionalLight(0xffffff, 1).position.set(5,10,7));

let items = [], questions = [], q = 0, score = 0, busy = false, gazed = null, gazeTime = 0;

const loader = new THREE.GLTFLoader();

// Load background with fallback
loader.load(BACKGROUND_FILE, g=>scene.add(g.scene), null, ()=>{ 
  const floor = new THREE.Mesh(new THREE.CircleGeometry(20,64), new THREE.MeshStandardMaterial({color:0xaaaaaa}));
  floor.rotation.x = -Math.PI/2; scene.add(floor);
});

// Start after short delay
setTimeout(() => {
  document.getElementById('loading').remove();
  document.getElementById('ui').style.display = 'block';
  document.getElementById('vr').style.display = 'block';
  generateQuestions();
  loadItems();
  updateQuestion();
  renderer.setAnimationLoop(animate);
}, 1500);

function generateQuestions() {
  const shuffled = [...vocab].sort(() => Math.random() - 0.5);
  questions = shuffled.map(item => ({
    prompt: Math.random() > 0.5 ? `Find the ${item.name}` : `Find: ${item.uses}`,
    correctAnswer: item.name
  }));
}

function loadItems() {
  const r = 4.2;
  vocab.forEach((itemData, i) => {
    const a = i * Math.PI * 2 / vocab.length;
    const x = Math.cos(a) * r, z = Math.sin(a) * r, y = 1.0;

    loader.load(itemData.link,
      gltf => {
        const obj = gltf.scene;
        obj.position.set(x, y, z);

        // FORCE CORRECT NAME (fixes "object_2" bug)
        obj.traverse(child => {
          if (child.isMesh || child.isObject3D) {
            child.userData.name = itemData.name;
            child.userData.uses = itemData.uses;
            child.name = itemData.name;
          }
        });

        // Perfect auto-size
        const box = new THREE.Box3().setFromObject(obj);
        const size = box.getSize(new THREE.Vector3()).length();
        obj.scale.setScalar(1.2 / size);

        obj.rotation.y = Math.random() * Math.PI;
        scene.add(obj);
        items.push(obj);
      },
      undefined,
      () => { // fallback cube
        const cube = new THREE.Mesh(new THREE.BoxGeometry(0.6,0.6,0.6), new THREE.MeshStandardMaterial({color:itemData.color}));
        cube.position.set(x,y,z);
        cube.userData.name = itemData.name;
        cube.userData.uses = itemData.uses;
        scene.add(cube);
        items.push(cube);
      }
    );
  });
}

function updateQuestion() {
  if (q >= questions.length) { showCompletion(); return; }
  document.getElementById('q').textContent = questions[q].prompt;
  document.getElementById('s').textContent = `Score: ${score}/10`;
}

function answer(obj) {
  if (busy) return;
  busy = true;
  const correct = obj.userData.name === questions[q].correctAnswer;
  if (correct) score++;

  const fb = document.getElementById('fb');
  fb.textContent = correct ? "Correct!" : "Wrong!";
  fb.className = correct ? "correct" : "incorrect";
  fb.style.display = "block";

  speak(correct ? `Correct! ${obj.userData.name}. ${obj.userData.uses}` : `Incorrect. That is ${obj.userData.name}. The correct answer was ${questions[q].correctAnswer}`);

  setTimeout(() => {
    fb.style.display = "none";
    q++;
    updateQuestion();
    busy = false;
  }, 3000);
}

function showCompletion() {
  const fb = document.getElementById('fb');
  fb.textContent = `Quiz Complete!\nScore: ${score}/10`;
  fb.className = "correct";
  fb.style.display = "block";
  speak(`Quiz complete! You scored ${score} out of 10`);
}

function speak(text) {
  if ('speechSynthesis' in window) {
    speechSynthesis.cancel();
    const utter = new SpeechSynthesisUtterance(text);
    utter.rate = 0.9;
    speechSynthesis.speak(utter);
  }
}

// 360° look (mouse + phone tilt)
let lon = 0, lat = 0;
document.addEventListener('mousemove', e => { lon = (e.clientX/innerWidth)*360-180; lat = -((e.clientY/innerHeight)*180-90); lat = Math.max(-85, Math.min(85, lat)); });
window.addEventListener('deviceorientation', e => { if(e.beta!==null) lat = e.beta-90; if(e.gamma!==null) lon += e.gamma*0.5; });

function animate() {
  // Smooth look
  lon *= 0.95; lat *= 0.95;
  const phi = THREE.MathUtils.degToRad(90 - lat);
  const theta = THREE.MathUtils.degToRad(lon);
  camera.lookAt(
    camera.position.x + Math.sin(phi)*Math.cos(theta)*10,
    camera.position.y + Math.cos(phi)*10,
    camera.position.z + Math.sin(phi)*Math.sin(theta)*10
  );

  items.forEach(o => o.rotation.y += 0.01);

  if (!busy) {
    const ray = new THREE.Raycaster();
    ray.setFromCamera(new THREE.Vector2(0,0), camera);
    const hits = ray.intersectObjects(items, true);
    if (hits.length) {
      let o = hits[0].object; while (o && !o.userData.name) o = o.parent;
      if (o?.userData.name) {
        if (gazed !== o) { gazed = o; gazeTime = performance.now(); document.getElementById('prog').style.display = 'block'; }
        else if (performance.now() - gazeTime > 2000) {
          document.getElementById('prog').style.display = 'none';
          answer(o); gazed = null;
        }
      }
    } else { gazed = null; document.getElementById('prog').style.display = 'none'; }
  }
  renderer.render(scene, camera);
}

// Tap support
renderer.domElement.addEventListener('click', () => {
  if (busy || items.length < 10) return;
  const ray = new THREE.Raycaster();
  ray.setFromCamera(new THREE.Vector2(0,0), camera);
  const hits = ray.intersectObjects(items, true);
  if (hits.length) { let o = hits[0].object; while (o && !o.userData.name) o = o.parent; if (o) answer(o); }
});

document.getElementById('vr').onclick = () => navigator.xr?.requestSession('immersive-vr').then(s => renderer.xr.setSession(s)).catch(() => alert('VR not available'));

window.onresize = () => { camera.aspect = innerWidth/innerHeight; camera.updateProjectionMatrix(); renderer.setSize(innerWidth, innerHeight); };
</script>
</body>
</html>

