<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Nursing VR Quiz â€“ Hospital Room</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/loaders/GLTFLoader.js"></script>
  <style>
    body { margin:0; overflow:hidden; background:#000; font-family:Arial,Helvetica,sans-serif; cursor: crosshair; }
    #loading { position:fixed; inset:0; background:#0a1a2f; color:#fff; display:flex; flex-direction:column; justify-content:center; align-items:center; z-index:9999; }
    #loading-info { margin-top: 20px; font-size: 14px; opacity: 0.7; max-width: 500px; text-align: center; }
    .loader { border:10px solid #1e3a5f; border-top:10px solid #1caad9; border-radius:50%; width:70px; height:70px; animation:s 1s linear infinite; margin:20px; }
    @keyframes s { to { transform:rotate(360deg); } }
    #ui { position:absolute; top:20px; left:50%; transform:translateX(-50%); background:rgba(0,0,0,0.8); color:#fff; padding:18px 35px; border-radius:15px; text-align:center; z-index:100; display:none; max-width: 90%; }
    #q { font-size:28px; font-weight:bold; margin:10px 0; }
    #s { font-size:22px; }
    #inst { font-size:14px; margin-top:10px; opacity:0.8; }
    #vr { position:fixed; bottom:25px; left:50%; transform:translateX(-50%); padding:18px 40px; font-size:22px; background:#1caad9; color:#fff; border:none; border-radius:50px; cursor:pointer; z-index:100; display:none; }
    #vr:hover { background:#1590b8; }
    #fb { position:fixed; top:50%; left:50%; transform:translate(-50%,-50%); font-size:60px; padding:40px 80px; border-radius:25px; display:none; z-index:200; font-weight:bold; text-align:center; }
    .correct { background:#006400; color:#fff; }
    .incorrect { background:#8B0000; color:#fff; }
    .gaze { position:fixed; top:50%; left:50%; width:30px; height:30px; border:3px solid rgba(255,255,255,0.8); border-radius:50%; transform:translate(-50%,-50%); pointer-events:none; z-index:99; }
    .prog { position:fixed; top:50%; left:50%; width:50px; height:50px; border:6px solid transparent; border-top:6px solid #00ffff; border-radius:50%; transform:translate(-50%,-50%); display:none; animation:s 2s linear infinite; z-index:99; }
  </style>
</head>
<body>

<div id="loading">
  <h1>Loading Hospital Room...</h1>
  <div class="loader"></div>
  <p id="loading-info">Preparing VR experience...</p>
</div>

<div id="ui">
  <div id="q">Find the Adhesive Bandage</div>
  <div id="s">Score: 0/10</div>
  <div id="inst">Move mouse to look around â€¢ Center crosshair on object for 2 seconds</div>
</div>

<div class="gaze"></div>
<div class="prog" id="prog"></div>
<div id="fb"></div>
<button id="vr">Enter VR Mode</button>

<script>
// ============= ALL FILES IN ROOT (NO FOLDERS!) =============
// Everything is in the same folder as index.html

const BACKGROUND_FILE = "./background.glb";

// Medical supply items - all in root folder!
const vocab = [
  {name:"Adhesive Bandage",     file:"bandage.glb",       color:0xF5DEB3, uses:"A small bandage to cover minor cuts or wounds"},
  {name:"Hand Sanitizer",       file:"sanitizer.glb",     color:0x87CEEB, uses:"A liquid used to disinfect hands"},
  {name:"Antiseptic Solution",  file:"antiseptic.glb",    color:0xDDA0DD, uses:"A liquid applied to wounds to prevent infection"},
  {name:"Cotton Balls",         file:"cotton.glb",        color:0xFFFFFF, uses:"Soft, absorbent material used for cleaning wounds"},
  {name:"Gauze",                file:"gauze.glb",         color:0xFAFAFA, uses:"A type of thin, woven fabric used for dressing wounds"},
  {name:"Medical Gloves",       file:"gloves.glb",        color:0x98D8C8, uses:"Disposable gloves worn during medical procedures"},
  {name:"Saline Solution",      file:"saline.glb",        color:0xADD8E6, uses:"A mixture of salt and water, used for cleaning wounds"},
  {name:"Scissors",             file:"scissors.glb",      color:0xC0C0C0, uses:"A tool for cutting"},
  {name:"Tweezers",             file:"tweezers.glb",      color:0xB0B0B0, uses:"A tool for picking up small objects"},
  {name:"Thermometer",          file:"thermometer.glb",   color:0xFF6B6B, uses:"A device used to measure body temperature"}
];
// ==========================================================

let q=0, score=0, busy=false, gazed=null, gazeTime=0;
let scene, camera, renderer, raycaster = new THREE.Raycaster();
let items = [];
let questions = [];

// Three.js setup
scene = new THREE.Scene();
scene.background = new THREE.Color(0x1a1a2e);

camera = new THREE.PerspectiveCamera(75, innerWidth/innerHeight, 0.1, 1000);
camera.position.set(0, 1.6, 0);

renderer = new THREE.WebGLRenderer({antialias:true});
renderer.setSize(innerWidth, innerHeight);
renderer.xr.enabled = true;
renderer.outputEncoding = THREE.sRGBEncoding;
document.body.appendChild(renderer.domElement);

raycaster = new THREE.Raycaster();

// Lights
scene.add(new THREE.AmbientLight(0xffffff, 0.6));
const dirLight = new THREE.DirectionalLight(0xffffff, 0.8);
dirLight.position.set(5, 10, 7);
scene.add(dirLight);
const pointLight = new THREE.PointLight(0xffffff, 0.5);
pointLight.position.set(-5, 5, -5);
scene.add(pointLight);

// Logging
function log(msg) {
  console.log(msg);
  document.getElementById('loading-info').textContent = msg;
}

// Load hospital background
log('Loading hospital room...');
const loader = new THREE.GLTFLoader();

loader.load(
  BACKGROUND_FILE,
  gltf => { 
    log('âœ“ Hospital room loaded!');
    const hospital = gltf.scene;
    hospital.scale.set(1, 1, 1);
    hospital.position.set(0, 0, 0);
    scene.add(hospital);
    setTimeout(() => startExperience(), 500);
  },
  xhr => {
    if (xhr.lengthComputable) {
      const percent = (xhr.loaded / xhr.total * 100).toFixed(0);
      const mb = (xhr.loaded / 1024 / 1024).toFixed(1);
      log(`Loading hospital: ${percent}% (${mb} MB)`);
    }
  },
  error => { 
    log('âœ— Hospital room failed. Using fallback...');
    console.error('Background error:', error);
    alert(`Could not load background.glb\n\nMake sure the file is in the same folder as index.html!`);
    createFallbackRoom(); 
    setTimeout(() => startExperience(), 500);
  }
);

function createFallbackRoom() {
  const floor = new THREE.Mesh(
    new THREE.CircleGeometry(15, 64), 
    new THREE.MeshStandardMaterial({color:0xd0d0d0, roughness:0.9})
  );
  floor.rotation.x = -Math.PI/2;
  scene.add(floor);

  const walls = new THREE.Mesh(
    new THREE.CylinderGeometry(15, 15, 6, 64, 1, true), 
    new THREE.MeshStandardMaterial({color:0xe0f2f7, side:THREE.BackSide, roughness:0.9})
  );
  walls.position.y = 3;
  scene.add(walls);

  const ceiling = new THREE.Mesh(
    new THREE.CircleGeometry(15, 64),
    new THREE.MeshStandardMaterial({color:0xffffff, side:THREE.BackSide})
  );
  ceiling.rotation.x = Math.PI/2;
  ceiling.position.y = 6;
  scene.add(ceiling);
}

function startExperience() {
  log('Starting quiz...');
  document.getElementById('loading').style.display = 'none';
  document.getElementById('ui').style.display = 'block';
  document.getElementById('vr').style.display = 'block';
  
  generateQuestions();
  loadItems();
  updateQuestion();
  renderer.setAnimationLoop(animate);
}

function generateQuestions() {
  const shuffled = [...vocab].sort(() => Math.random() - 0.5);
  questions = shuffled.map(item => {
    const useNamePrompt = Math.random() > 0.5;
    return {
      prompt: useNamePrompt ? `Find the ${item.name}` : `Find: ${item.uses}`,
      correctAnswer: item.name,
      item: item
    };
  });
}

function loadItems() {
  const radius = 3.5;
  const angleStep = (Math.PI * 2) / vocab.length;
  
  questions.forEach((question, i) => {
    const angle = i * angleStep;
    const x = Math.cos(angle) * radius;
    const z = Math.sin(angle) * radius;
    const y = 1.2 + (Math.random() * 0.4);
    
    const itemData = question.item;
    const modelPath = `./${itemData.file}`; // Just ./filename.glb

    loader.load(
      modelPath,
      gltf => {
        const obj = gltf.scene;
        obj.position.set(x, y, z);
        obj.scale.setScalar(0.4 + Math.random() * 0.3);
        obj.userData.name = itemData.name;
        obj.userData.uses = itemData.uses;
        obj.lookAt(camera.position);
        scene.add(obj);
        items.push(obj);
        console.log(`âœ“ Loaded: ${itemData.name}`);
      },
      undefined,
      error => {
        console.warn(`âœ— Failed: ${itemData.name} at ${modelPath}`);
        console.error(error);
        
        // Fallback cube
        const cube = new THREE.Mesh(
          new THREE.BoxGeometry(0.4, 0.4, 0.4),
          new THREE.MeshStandardMaterial({
            color: itemData.color,
            emissive: itemData.color,
            emissiveIntensity: 0.3,
            metalness: 0.2,
            roughness: 0.6
          })
        );
        cube.position.set(x, y, z);
        cube.userData.name = itemData.name;
        cube.userData.uses = itemData.uses;
        scene.add(cube);
        items.push(cube);
      }
    );
  });
}

function updateQuestion() {
  if (q >= questions.length) { showCompletion(); return; }
  document.getElementById('q').innerHTML = `<strong>${questions[q].prompt}</strong>`;
  document.getElementById('s').textContent = `Score: ${score}/${questions.length}`;
}

function answer(obj) {
  if (busy) return;
  busy = true;
  const correct = obj.userData.name === questions[q].correctAnswer;
  if (correct) score++;

  const fb = document.getElementById('fb');
  fb.className = correct ? 'correct' : 'incorrect';
  fb.innerHTML = correct 
    ? `âœ“ Correct!<br>${obj.userData.name}` 
    : `âœ— Incorrect<br>You selected: ${obj.userData.name}<br>Correct: ${questions[q].correctAnswer}`;
  fb.style.display = 'block';

  if (correct) {
    speak(`Correct! ${obj.userData.name}. ${obj.userData.uses}`);
  } else {
    speak(`Incorrect. That is ${obj.userData.name}. The correct answer was ${questions[q].correctAnswer}`);
  }
  
  setTimeout(() => fb.style.display = 'none', 2800);
  setTimeout(() => { q++; updateQuestion(); busy = false; }, 3000);
}

function showCompletion() {
  const fb = document.getElementById('fb');
  fb.className = 'correct';
  fb.innerHTML = `ðŸŽ‰ Quiz Complete!<br>Score: ${score}/${questions.length}`;
  fb.style.display = 'block';
  fb.style.fontSize = '48px';
  speak(`Quiz complete! You scored ${score} out of ${questions.length}`);
  setTimeout(() => { 
    if (confirm(`You scored ${score}/${questions.length}!\n\nPlay again?`)) {
      location.reload();
    }
  }, 3000);
}

function speak(text) {
  if ('speechSynthesis' in window) {
    window.speechSynthesis.cancel();
    const utterance = new SpeechSynthesisUtterance(text);
    utterance.rate = 0.9;
    utterance.pitch = 1;
    utterance.volume = 1;
    window.speechSynthesis.speak(utterance);
  }
}

// VR-style mouse controls (no dragging!)
let mouseX = 0, mouseY = 0, targetRotationY = 0, targetRotationX = 0;

document.addEventListener('mousemove', e => {
  mouseX = (e.clientX / innerWidth) * 2 - 1;
  mouseY = (e.clientY / innerHeight) * 2 - 1;
  targetRotationY = mouseX * Math.PI;
  targetRotationX = -mouseY * (Math.PI / 3);
});

function updateCamera() {
  camera.rotation.y += (targetRotationY - camera.rotation.y) * 0.1;
  camera.rotation.x += (targetRotationX - camera.rotation.x) * 0.1;
  camera.rotation.x = Math.max(-Math.PI/2.5, Math.min(Math.PI/2.5, camera.rotation.x));
}

function animate() {
  updateCamera();
  
  // Rotate items for visibility
  items.forEach(obj => obj.rotation.y += 0.005);

  // Gaze detection
  if (!busy) {
    raycaster.setFromCamera(new THREE.Vector2(0, 0), camera);
    const hits = raycaster.intersectObjects(items, true);
    
    if (hits.length) {
      let obj = hits[0].object;
      while (obj && !obj.userData?.name) obj = obj.parent;
      
      if (obj?.userData?.name) {
        if (gazed !== obj) { 
          gazed = obj; 
          gazeTime = Date.now(); 
          document.getElementById('prog').style.display = 'block'; 
        } else if (Date.now() - gazeTime > 2000) { 
          document.getElementById('prog').style.display = 'none'; 
          answer(obj); 
          gazed = null; 
        }
      }
    } else { 
      gazed = null; 
      document.getElementById('prog').style.display = 'none'; 
    }
  }
  
  renderer.render(scene, camera);
}

// Click support
document.addEventListener('click', () => {
  if (busy) return;
  raycaster.setFromCamera(new THREE.Vector2(0, 0), camera);
  const hits = raycaster.intersectObjects(items, true);
  if (hits.length) {
    let obj = hits[0].object;
    while (obj && !obj.userData?.name) obj = obj.parent;
    if (obj?.userData?.name) answer(obj);
  }
});

// VR button
document.getElementById('vr').onclick = () => {
  if ('xr' in navigator) {
    navigator.xr.requestSession('immersive-vr', { 
      optionalFeatures: ['local-floor', 'bounded-floor'] 
    })
    .then(session => renderer.xr.setSession(session))
    .catch(err => { 
      alert('Could not start VR.\n\nMake sure:\n- You\'re on HTTPS\n- VR device is connected\n- WebXR is enabled'); 
      console.error(err); 
    });
  } else {
    alert('WebXR not supported.\n\nTry Chrome/Edge on Android or Oculus Browser on Quest.');
  }
};

// Window resize
window.addEventListener('resize', () => {
  camera.aspect = innerWidth / innerHeight;
  camera.updateProjectionMatrix();
  renderer.setSize(innerWidth, innerHeight);
});
</script>
</body>
</html>
