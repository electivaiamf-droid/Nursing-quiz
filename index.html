<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
  <title>Nursing VR Quiz – VR Fixed</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/loaders/GLTFLoader.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/webxr/VRButton.js"></script>
  <style>
    body { margin:0; overflow:hidden; background:#000; font-family:sans-serif; }
    #loading { position:fixed; inset:0; background:#0a1a2f; color:#fff; display:flex; flex-direction:column; justify-content:center; align-items:center; z-index:9999; }
    .loader { border:16px solid #1e3a5f; border-top:16px solid #1caad9; border-radius:50%; width:90px; height:90px; animation:s 1s linear infinite; }
    @keyframes s { to { transform:rotate(360deg); } }
    #ui { position:fixed; top:10px; left:50%; transform:translateX(-50%); background:rgba(0,0,0,0.8); color:#fff; padding:20px 40px; border-radius:20px; z-index:100; display:none; width:90%; text-align:center; }
    #q { font-size:36px; font-weight:bold; line-height:1.2; }
    #s { font-size:30px; margin-top:10px; }
    #vr { position:fixed; bottom:30px; left:50%; transform:translateX(-50%); padding:20px 60px; font-size:30px; background:#00bcd4; color:#fff; border:none; border-radius:50px; z-index:100; display:none; cursor:pointer; }
    #calibrate { position:fixed; bottom:100px; left:50%; transform:translateX(-50%); padding:10px 20px; font-size:18px; background:#ff9800; color:#fff; border:none; border-radius:10px; z-index:100; display:none; cursor:pointer; }
    .reticle { position:fixed; top:50%; left:50%; width:50px; height:50px; border:5px solid #fff; border-radius:50%; transform:translate(-50%,-50%); pointer-events:none; z-index:99; }
    .prog { position:fixed; top:50%; left:50%; width:80px; height:80px; border:10px solid transparent; border-top:10px solid cyan; border-radius:50%; transform:translate(-50%,-50%); display:none; animation:s 2s linear; z-index:99; }
  </style>
</head>
<body>
  <div id="loading">
    <h1>Loading Hospital...</h1>
    <div class="loader"></div>
  </div>
  <div id="ui">
    <div id="q">Find the Adhesive Bandage</div>
    <div id="s">Score: 0/10</div>
  </div>
  <div class="reticle"></div>
  <div class="prog" id="prog"></div>
  <div id="fb" style="display:none; position:fixed; top:50%; left:50%; transform:translate(-50%,-50%); font-size:70px; padding:40px 80px; border-radius:30px; z-index:200; text-align:center;"></div>
  <button id="vr"></button>
  <button id="calibrate" onclick="calibrateTilt()">Calibrate Tilt</button>

  <script>
    const BACKGROUND_FILE = "https://files.catbox.moe/reiuka.glb";

    const vocab = [
      {name:"Adhesive Bandage",     link:"https://files.catbox.moe/edy3gw.glb", color:0xF5DEB3},
      {name:"Hand Sanitizer",       link:"https://files.catbox.moe/o997s6.glb", color:0x87CEEB},
      {name:"Antiseptic Solution",  link:"https://files.catbox.moe/1t002n.glb", color:0xDDA0DD},
      {name:"Cotton Balls",         link:"https://files.catbox.moe/eay3dl.glb", color:0xFFFFFF},
      {name:"Gauze",                link:"https://files.catbox.moe/vm9c7n.glb", color:0xFAFAFA},
      {name:"Medical Gloves",       link:"https://files.catbox.moe/2tifp9.glb", color:0x98D8C8},
      {name:"Saline Solution",      link:"https://files.catbox.moe/dgg8tw.glb", color:0xADD8E6},
      {name:"Scissors",             link:"https://files.catbox.moe/bc4xkb.glb", color:0xC0C0C0},
      {name:"Tweezers",             link:"https://files.catbox.moe/pf2i81.glb", color:0xB0B0B0},
      {name:"Thermometer",          link:"https://files.catbox.moe/0glqs3.glb", color:0xFF6B6B}
    ];

    let scene = new THREE.Scene();
    let camera = new THREE.PerspectiveCamera(70, innerWidth/innerHeight, 0.01, 1000);
    let renderer = new THREE.WebGLRenderer({antialias: true, powerPreference: "high-performance"});
    renderer.setPixelRatio(window.devicePixelRatio);
    renderer.setSize(innerWidth, innerHeight);
    renderer.xr.enabled = true;
    renderer.xr.setReferenceSpaceType('local-floor');
    document.body.appendChild(renderer.domElement);

    scene.background = new THREE.Color(0x0a1a2f);
    camera.position.y = 1.6;
    scene.add(new THREE.AmbientLight(0xffffff, 1.2));
    scene.add(new THREE.DirectionalLight(0xffffff, 1).position.set(5,10,7));

    const loader = new THREE.GLTFLoader();
    let items = [], q = 0, score = 0, busy = false, gazed = null, gazeTime = 0, xrSession = null;

    // VR session events
    renderer.xr.addEventListener('sessionstart', () => {
      xrSession = renderer.xr.getSession();
      document.getElementById('ui').style.display = 'none';
      document.getElementById('vr').style.display = 'none';
      document.getElementById('calibrate').style.display = 'none';
      console.log('VR started - UI hidden');
    });
    renderer.xr.addEventListener('sessionend', () => {
      xrSession = null;
      document.getElementById('ui').style.display = 'block';
      document.getElementById('vr').style.display = 'block';
      document.getElementById('calibrate').style.display = 'block';
      console.log('VR ended - UI shown');
    });

    // Load background
    loader.load(BACKGROUND_FILE, g => scene.add(g.scene), null, () => {
      const floor = new THREE.Mesh(new THREE.CircleGeometry(20,64), new THREE.MeshStandardMaterial({color:0xaaaaaa}));
      floor.rotation.x = -Math.PI/2; scene.add(floor);
    });

    // Damped look-around (less sensitive)
    let lon = 0, lat = 0;
    document.addEventListener('mousemove', e => {
      lon = (e.clientX / innerWidth) * 360 - 180;
      lat = -(e.clientY / innerHeight) * 180 + 90;
      lat = Math.max(-85, Math.min(85, lat));
    });
    window.addEventListener('deviceorientation', e => {
      if(e.beta !== null) lat = e.beta - 90;
      if(e.gamma !== null) lon += e.gamma * 0.5;
    });

    function calibrateTilt() {
      lon = 0; lat = 0;
      console.log('Tilt calibrated');
    }

    // Start
    setTimeout(() => {
      document.getElementById('loading').remove();
      document.getElementById('ui').style.display = 'block';
      document.getElementById('vr').style.display = 'block';
      document.getElementById('calibrate').style.display = 'block';
      loadItems();
      nextQuestion();
      renderer.setAnimationLoop(animate);
    }, 1500);

    function loadItems(){
      const r = 4.2;
      vocab.forEach((it,i) => {
        const a = i*Math.PI*2/vocab.length, x = Math.cos(a)*r, z = Math.sin(a)*r, y = 0.8;
        loader.load(it.link, gltf => {
          const obj = gltf.scene; obj.position.set(x,y,z); obj.userData.name = it.name;
          const box = new THREE.Box3().setFromObject(obj);
          const size = box.getSize(new THREE.Vector3());
          const maxDim = Math.max(size.x,size.y,size.z);
          const maxAllowed = (it.name.includes("Scissors")||it.name.includes("Thermometer")||it.name.includes("Tweezers")) ? 0.55 : 0.8;
          obj.scale.setScalar(Math.min(maxAllowed/maxDim, 4));
          obj.rotation.y = Math.random()*Math.PI;
          scene.add(obj); items.push(obj);
        });
      });
    }

    function nextQuestion(){
      const shuffled = [...vocab].sort(()=>Math.random()-0.5);
      document.getElementById('q').textContent = `Find the ${shuffled[q].name}`;
      document.getElementById('s').textContent = `Score: ${score}/10`;
    }

    function answer(obj){
      if(busy) return; busy = true;
      const correct = obj.userData.name === document.getElementById('q').textContent.split("the ")[1];
      if(correct) score++;
      const fb = document.getElementById('fb');
      fb.textContent = correct ? "Correct!" : "Wrong!";
      fb.className = correct ? "correct" : "incorrect";
      fb.style.display = "block";
      setTimeout(()=>{
        fb.style.display = "none";
        q++;
        if(q < 10) nextQuestion();
        else { fb.textContent = `Finished! ${score}/10`; fb.className = "correct"; fb.style.display = "block"; }
        busy = false;
      }, 2500);
    }

    function animate(){
      // Damped look-around (sensitivity fixed)
      lon *= 0.7; lat *= 0.7;  // ← 0.7 = smooth, no twitch
      const phi = THREE.MathUtils.degToRad(90 - lat);
      const theta = THREE.MathUtils.degToRad(lon);
      camera.lookAt(
        camera.position.x + Math.sin(phi) * Math.cos(theta) * 10,
        camera.position.y + Math.cos(phi) * 10,
        camera.position.z + Math.sin(phi) * Math.sin(theta) * 10
      );

      items.forEach(o => o.rotation.y += 0.01);

      if(!busy){
        const raycaster = new THREE.Raycaster();
        raycaster.setFromCamera(new THREE.Vector2(0,0), camera);
        const hits = raycaster.intersectObjects(items, true);
        if(hits.length){
          let o = hits[0].object; while(o && !o.userData.name) o = o.parent;
          if(o?.userData.name){
            if(gazed !== o){ gazed = o; gazeTime = performance.now(); document.getElementById('prog').style.display = 'block'; }
            else if(performance.now() - gazeTime > 2000){
              document.getElementById('prog').style.display = 'none';
              answer(o); gazed = null;
            }
          }
        }else{ gazed = null; document.getElementById('prog').style.display = 'none'; }
      }
      renderer.render(scene, camera);
    }

    renderer.domElement.addEventListener('click', () => {
      if(busy || items.length < 10) return;
      const raycaster = new THREE.Raycaster();
      raycaster.setFromCamera(new THREE.Vector2(0,0), camera);
      const hits = raycaster.intersectObjects(items, true);
      if(hits.length){ let o = hits[0].object; while(o && !o.userData.name) o = o.parent; if(o) answer(o); }
    });

    document.getElementById('vr').onclick = () => {
      // Request VR with domOverlay for UI
      navigator.xr.requestSession('immersive-vr', {
        optionalFeatures: ['dom-overlay', 'dom-overlay-for-handheld-ar'],
        domOverlay: { root: document.body }  // ← UI overlays in VR
      }).then(session => {
        renderer.xr.setSession(session);
      }).catch(err => {
        alert('VR not available. Try Chrome on Android or Quest browser.');
        console.error(err);
      });
    };

    window.onresize = () => {
      camera.aspect = innerWidth/innerHeight;
      camera.updateProjectionMatrix();
      renderer.setSize(innerWidth, innerHeight);
    };
  </script>
</body>
</html>
