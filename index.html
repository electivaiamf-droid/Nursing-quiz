<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1,user-scalable=no">
<title>Nursing VR Quiz</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/loaders/GLTFLoader.js"></script>
<style>
body{margin:0;overflow:hidden;background:#000;font-family:sans-serif;touch-action:none}
#loading{position:fixed;inset:0;background:#0a1a2f;color:#fff;display:flex;flex-direction:column;justify-content:center;align-items:center;z-index:9999}
.loader{border:12px solid #1e3a5f;border-top:12px solid #1caad9;border-radius:50%;width:70px;height:70px;animation:s 1s linear infinite}
@keyframes s{to{transform:rotate(360deg)}}
#ui{position:fixed;top:15px;left:50%;transform:translateX(-50%);background:rgba(0,0,0,.85);color:#fff;padding:18px 35px;border-radius:18px;z-index:100;display:none;max-width:90%;text-align:center}
#q{font-size:32px;font-weight:bold;margin-bottom:8px}
#s{font-size:24px}
#timer{font-size:28px;margin-top:8px;color:#00ff00;font-weight:bold}
#vr{position:fixed;bottom:25px;left:50%;transform:translateX(-50%);padding:16px 50px;font-size:26px;background:#00bcd4;color:#fff;border:none;border-radius:40px;z-index:100;display:none;cursor:pointer}
#fb{position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);font-size:60px;font-weight:bold;padding:35px 70px;border-radius:25px;display:none;z-index:200;text-align:center;line-height:1.3}
.correct{background:#006400;color:#fff}
.incorrect{background:#8B0000;color:#fff}
.reticle{position:fixed;top:50%;left:50%;width:50px;height:50px;border:5px solid #fff;border-radius:50%;transform:translate(-50%,-50%);pointer-events:none;z-index:99}
.prog{position:fixed;top:50%;left:50%;width:70px;height:70px;border:8px solid transparent;border-top:8px solid cyan;border-radius:50%;transform:translate(-50%,-50%);display:none;animation:s 2s linear;z-index:99}
</style>
</head>
<body>
<div id="loading"><h1>Loading...</h1><div class="loader"></div></div>
<div id="ui"><div id="q"></div><div id="s">Score: 0/10</div><div id="timer">Time: 5:00</div></div>
<div class="reticle"></div>
<div class="prog" id="prog"></div>
<div id="fb"></div>
<button id="vr">Enter VR</button>

<script>
const BG="https://files.catbox.moe/reiuka.glb";
const vocab=[
  {name:"Adhesive Bandage",link:"https://files.catbox.moe/edy3gw.glb",color:0xF5DEB3,uses:"A small bandage to cover minor cuts or wounds"},
  {name:"Hand Sanitizer",link:"https://files.catbox.moe/o997s6.glb",color:0x87CEEB,uses:"A liquid used to disinfect hands"},
  {name:"Antiseptic Solution",link:"https://files.catbox.moe/1t002n.glb",color:0xDDA0DD,uses:"A liquid applied to wounds to prevent infection"},
  {name:"Cotton Balls",link:"https://files.catbox.moe/eay3dl.glb",color:0xFFFFFF,uses:"Soft, absorbent material used for cleaning wounds"},
  {name:"Gauze",link:"https://files.catbox.moe/vm9c7n.glb",color:0xFAFAFA,uses:"A type of thin, woven fabric used for dressing wounds"},
  {name:"Medical Gloves",link:"https://files.catbox.moe/2tifp9.glb",color:0x98D8C8,uses:"Disposable gloves worn during medical procedures"},
  {name:"Saline Solution",link:"https://files.catbox.moe/dgg8tw.glb",color:0xADD8E6,uses:"A mixture of salt and water, used for cleaning wounds"},
  {name:"Scissors",link:"https://files.catbox.moe/bc4xkb.glb",color:0xC0C0C0,uses:"A tool for cutting"},
  {name:"Tweezers",link:"https://files.catbox.moe/pf2i81.glb",color:0xB0B0B0,uses:"A tool for picking up small objects"},
  {name:"Thermometer",link:"https://files.catbox.moe/0glqs3.glb",color:0xFF6B6B,uses:"A device used to measure body temperature"}
];

let scene=new THREE.Scene(),camera=new THREE.PerspectiveCamera(75,innerWidth/innerHeight,.1,1000),renderer=new THREE.WebGLRenderer({antialias:true,powerPreference:"high-performance"});
scene.background=new THREE.Color(0x0a1a2f);camera.position.y=1.6;
renderer.setPixelRatio(Math.min(devicePixelRatio,2));renderer.setSize(innerWidth,innerHeight);renderer.xr.enabled=true;document.body.appendChild(renderer.domElement);
scene.add(new THREE.AmbientLight(0xffffff,.9));
scene.add(new THREE.DirectionalLight(0xffffff,1).position.set(5,10,7));
scene.add(camera);

let items=[],questions=[],q=0,score=0,busy=false,gazed=null,gazeTime=0,isVR=false,timeLeft=300,timerInterval;

// 3D VR reticle
const reticle3D=new THREE.Mesh(
  new THREE.RingGeometry(.015,.02,32),
  new THREE.MeshBasicMaterial({color:0xffffff,side:THREE.DoubleSide,transparent:true,opacity:.9})
);
reticle3D.position.set(0,0,-1);
camera.add(reticle3D);
reticle3D.visible=false;

// 3D VR progress ring
const progRing3D=new THREE.Mesh(
  new THREE.RingGeometry(.025,.03,32),
  new THREE.MeshBasicMaterial({color:0x00ffff,side:THREE.DoubleSide,transparent:true,opacity:.9})
);
progRing3D.position.set(0,0,-1);
camera.add(progRing3D);
progRing3D.visible=false;

// 3D VR text
function createVRText(txt){
  const canvas=document.createElement('canvas');
  canvas.width=2048;canvas.height=512;
  const ctx=canvas.getContext('2d');
  ctx.fillStyle='rgba(0,0,0,0.85)';
  ctx.fillRect(0,0,canvas.width,canvas.height);
  ctx.font='bold 80px Arial';
  ctx.fillStyle='#fff';
  ctx.textAlign='center';
  ctx.textBaseline='middle';
  
  // Word wrap
  const words=txt.split(' ');
  let line='',y=200;
  for(let word of words){
    const test=line+word+' ';
    if(ctx.measureText(test).width>1900&&line!==''){
      ctx.fillText(line,canvas.width/2,y);
      line=word+' ';
      y+=100;
    }else line=test;
  }
  ctx.fillText(line,canvas.width/2,y);
  
  const tex=new THREE.CanvasTexture(canvas);
  const sprite=new THREE.Sprite(new THREE.SpriteMaterial({map:tex}));
  sprite.scale.set(3,.75,1);
  sprite.position.set(0,.6,-1.8);
  sprite.renderOrder=999;
  return sprite;
}

let vrText=createVRText("Loading...");
camera.add(vrText);
vrText.visible=false;

const loader=new THREE.GLTFLoader();
loader.load(BG,g=>scene.add(g.scene),null,()=>{
  const f=new THREE.Mesh(new THREE.CircleGeometry(20,64),new THREE.MeshStandardMaterial({color:0xaaa}));
  f.rotation.x=-Math.PI/2;
  scene.add(f);
});

function loadItems(){
  const radius=3.2,heightMin=.1,heightMax=3;
  vocab.forEach((item,i)=>{
    const angle=i*Math.PI*2/vocab.length,x=Math.cos(angle)*radius,z=Math.sin(angle)*radius,y=heightMin+Math.random()*(heightMax-heightMin);
    loader.load(item.link,gltf=>{
      const obj=gltf.scene;
      obj.position.set(x,y,z);
      obj.traverse(c=>{c.userData.name=item.name;c.userData.uses=item.uses;});
      const box=new THREE.Box3().setFromObject(obj);
      const size=box.getSize(new THREE.Vector3()).length();
      obj.scale.setScalar(1.3/size);
      obj.rotation.y=Math.random()*Math.PI;
      scene.add(obj);
      items.push(obj);
    },null,()=>{
      const cube=new THREE.Mesh(new THREE.BoxGeometry(.7,.7,.7),new THREE.MeshStandardMaterial({color:item.color,emissive:item.color,emissiveIntensity:.4}));
      cube.position.set(x,y,z);
      cube.userData.name=item.name;
      cube.userData.uses=item.uses;
      scene.add(cube);
      items.push(cube);
    });
  });
}

function genQ(){
  questions=vocab.map(item=>({prompt:Math.random()>.5?`Find the ${item.name}`:`Find: ${item.uses}`,answer:item.name,item:item}));
  questions.sort(()=>Math.random()-.5);
}

function updateQ(){
  if(q>=questions.length){showEnd();return}
  const prompt=questions[q].prompt;
  document.getElementById('q').textContent=prompt;
  document.getElementById('s').textContent=`Score: ${score}/10`;
  updateTimer();
  
  // Update VR text
  if(isVR){
    camera.remove(vrText);
    vrText.geometry?.dispose();
    vrText.material?.map?.dispose();
    vrText.material?.dispose();
    vrText=createVRText(`${prompt}\nScore: ${score}/10`);
    camera.add(vrText);
    vrText.visible=true;
  }
}

function updateTimer(){
  const mins=Math.floor(timeLeft/60),secs=timeLeft%60;
  const timerEl=document.getElementById('timer');
  timerEl.textContent=`Time: ${mins}:${secs<10?'0':''}${secs}`;
  if(timeLeft<=30)timerEl.style.color='#f00';
  else if(timeLeft<=60)timerEl.style.color='#f90';
  else timerEl.style.color='#0f0';
}

function startTimer(){
  timerInterval=setInterval(()=>{
    timeLeft--;
    updateTimer();
    if(timeLeft<=0){clearInterval(timerInterval);showEnd(true);}
  },1000);
}

function answer(obj){
  if(busy)return;
  busy=true;
  const selectedName=obj.userData.name,correctName=questions[q].answer,correct=selectedName===correctName;
  if(correct)score++;
  
  const fb=document.getElementById('fb');
  fb.className=correct?'correct':'incorrect';
  fb.innerHTML=correct?'‚úì Correct!':`‚úó Incorrect<br>That's ${selectedName}<br>Correct: ${correctName}`;
  fb.style.display='block';
  
  speak(correct?`Correct! ${selectedName}. ${obj.userData.uses}`:`Incorrect. That is ${selectedName}. The correct answer was ${correctName}`);
  
  setTimeout(()=>{fb.style.display='none';q++;updateQ();busy=false;},3000);
}

function showEnd(timeUp){
  clearInterval(timerInterval);
  const fb=document.getElementById('fb');
  fb.className='correct';
  fb.innerHTML=timeUp?`‚è∞ Time's Up!<br>Score: ${score}/10`:`üéâ Quiz Complete!<br>Score: ${score}/10<br>Time: ${formatTime(300-timeLeft)}`;
  fb.style.display='block';
  speak(timeUp?`Time's up! You scored ${score} out of 10`:`Quiz complete! You scored ${score} out of 10`);
}

function formatTime(s){const m=Math.floor(s/60),sec=s%60;return `${m}:${sec<10?'0':''}${sec}`;}
function speak(t){if('speechSynthesis'in window){speechSynthesis.cancel();const u=new SpeechSynthesisUtterance(t);u.rate=.9;speechSynthesis.speak(u);}}

// Controls
let targetRotX=0,targetRotY=0,currentRotX=0,currentRotY=0,lastMouseX=innerWidth/2,lastMouseY=innerHeight/2,lastTouchX=0,lastTouchY=0,touching=false;

document.addEventListener('mousemove',e=>{
  if(isVR)return;
  const dx=e.clientX-lastMouseX,dy=e.clientY-lastMouseY;
  targetRotY+=dx*.005;
  targetRotX-=dy*.005;
  targetRotX=Math.max(-Math.PI/3,Math.min(Math.PI/3,targetRotX));
  lastMouseX=e.clientX;
  lastMouseY=e.clientY;
});

document.addEventListener('touchstart',e=>{touching=true;lastTouchX=e.touches[0].clientX;lastTouchY=e.touches[0].clientY;});
document.addEventListener('touchmove',e=>{
  if(!touching||isVR)return;
  e.preventDefault();
  const dx=e.touches[0].clientX-lastTouchX,dy=e.touches[0].clientY-lastTouchY;
  targetRotY+=dx*.005;
  targetRotX-=dy*.005;
  targetRotX=Math.max(-Math.PI/3,Math.min(Math.PI/3,targetRotX));
  lastTouchX=e.touches[0].clientX;
  lastTouchY=e.touches[0].clientY;
},{passive:false});
document.addEventListener('touchend',()=>touching=false);

function animate(){
  // Camera control
  if(!isVR){
    currentRotY+=(targetRotY-currentRotY)*.1;
    currentRotX+=(targetRotX-currentRotX)*.1;
    camera.rotation.order='YXZ';
    camera.rotation.y=currentRotY;
    camera.rotation.x=currentRotX;
  }
  
  // Rotate items
  items.forEach(o=>o.rotation.y+=.008);
  
  // Gaze detection
  if(!busy&&items.length>0){
    const ray=new THREE.Raycaster();
    ray.setFromCamera(new THREE.Vector2(0,0),camera);
    const hits=ray.intersectObjects(items,true);
    
    if(hits.length){
      let obj=hits[0].object;
      while(obj&&!obj.userData.name)obj=obj.parent;
      
      if(obj?.userData.name){
        if(gazed!==obj){
          gazed=obj;
          gazeTime=performance.now();
          if(isVR){
            reticle3D.visible=true;
            progRing3D.visible=true;
          }else{
            document.getElementById('prog').style.display='block';
          }
        }else{
          const elapsed=performance.now()-gazeTime;
          
          // Animate progress ring in VR
          if(isVR&&progRing3D.visible){
            const progress=Math.min(elapsed/2000,1);
            progRing3D.geometry.dispose();
            progRing3D.geometry=new THREE.RingGeometry(.025,.03,32,1,0,Math.PI*2*progress);
          }
          
          if(elapsed>2000){
            if(isVR){
              reticle3D.visible=false;
              progRing3D.visible=false;
            }else{
              document.getElementById('prog').style.display='none';
            }
            answer(obj);
            gazed=null;
          }
        }
      }
    }else{
      gazed=null;
      if(isVR){
        reticle3D.visible=false;
        progRing3D.visible=false;
      }else{
        document.getElementById('prog').style.display='none';
      }
    }
  }
  
  renderer.render(scene,camera);
}

// Click support
renderer.domElement.addEventListener('click',()=>{
  if(busy||items.length<10)return;
  const ray=new THREE.Raycaster();
  ray.setFromCamera(new THREE.Vector2(0,0),camera);
  const hits=ray.intersectObjects(items,true);
  if(hits.length){
    let obj=hits[0].object;
    while(obj&&!obj.userData.name)obj=obj.parent;
    if(obj?.userData.name)answer(obj);
  }
});

// VR button
document.getElementById('vr').onclick=()=>{
  if(!navigator.xr)return alert('WebXR not supported');
  navigator.xr.requestSession('immersive-vr',{optionalFeatures:['local-floor','bounded-floor']})
    .then(s=>{renderer.xr.setSession(s);})
    .catch(()=>alert('VR not available'));
};

// VR session events
renderer.xr.addEventListener('sessionstart',()=>{
  isVR=true;
  reticle3D.visible=true;
  vrText.visible=true;
  document.querySelector('.reticle').style.display='none';
  document.getElementById('ui').style.display='none';
  document.getElementById('vr').style.display='none';
  updateQ(); // Refresh VR text
  console.log('‚úì VR started - 3D UI active');
});

renderer.xr.addEventListener('sessionend',()=>{
  isVR=false;
  reticle3D.visible=false;
  vrText.visible=false;
  progRing3D.visible=false;
  document.querySelector('.reticle').style.display='block';
  document.getElementById('ui').style.display='block';
  document.getElementById('vr').style.display='block';
  console.log('‚úì VR ended - HTML UI active');
});

// Start
window.onresize=()=>{camera.aspect=innerWidth/innerHeight;camera.updateProjectionMatrix();renderer.setSize(innerWidth,innerHeight);};

setTimeout(()=>{
  document.getElementById('loading').remove();
  document.getElementById('ui').style.display='block';
  document.getElementById('vr').style.display='block';
  genQ();
  loadItems();
  updateQ();
  startTimer();
  renderer.setAnimationLoop(animate);
},1200);
</script>
</body>
</html>



